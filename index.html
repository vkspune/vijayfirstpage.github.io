<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PayPal App Switch (Braintree v3)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Braintree Web SDK -->
  <script src="https://js.braintreegateway.com/web/3.136.0/js/client.min.js"></script>
  <script src="https://js.braintreegateway.com/web/3.136.0/js/paypal-checkout.min.js"></script>
  <script src="https://js.braintreegateway.com/web/3.136.0/js/data-collector.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif; padding: 24px; }
    #paypal-button-container { margin-top: 16px; }
    pre { background:#f5f5f5; padding:12px; border-radius:6px; white-space:pre-wrap; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom: 12px; }
    input, select { padding:6px 8px; }
    button { padding:8px 12px; cursor:pointer; }
    .small { font-size: 12px; opacity: 0.8; }
  </style>
</head>

<body>
  <h1>PayPal App Switch — Test Page</h1>

  <div class="row">
    <label>Amount (USD):
      <input id="amount" value="10.00" style="width:100px" />
    </label>

    <label>Intent:
      <select id="intent">
        <option value="capture" selected>capture</option>
        <option value="authorize">authorize</option>
      </select>
    </label>

    <label>User Action:
      <select id="userAction">
        <option value="commit" selected>commit</option>
        <option value="continue">continue</option>
      </select>
    </label>

    <label>
      <input id="enableAppSwitch" type="checkbox" checked />
      App Switch
    </label>

    <label>
      <input id="appswitchNewTab" type="checkbox" />
      App Switch in new tab
    </label>

    <button id="render">Render PayPal Button</button>
  </div>

  <div class="small">
    Static hosting note: this demo tokenizes and shows the Braintree nonce; it does not create a transaction (needs a server).
  </div>

  <div id="paypal-button-container"></div>

  <h3>Tokenization output</h3>
  <pre id="output">(nonce will appear here after approval)</pre>

  <h3>Logs</h3>
  <pre id="log"></pre>

  <script>
    // ======= Client token (for demo only) =======
    // For production: fetch from your server per session.
    let clientToken = "eyJ2ZXJzaW9uIjoyLCJhdXRob3JpemF0aW9uRmluZ2VycHJpbnQiOiJleUpyYVdRaU9pSXlNREU0TURReU5qRTJMWE5oYm1SaWIzZ2lMQ0pwYzNNaU9pSm9kSFJ3Y3pvdkwyRndhUzV6WVc1a1ltOTRMbUp5WVdsdWRISmxaV2RoZEdWM1lYa3VZMjl0SWl3aVlXeG5Jam9pUlZNeU5UWWlmUS5leUpsZUhBaU9qRTNOekUxTkRNNU5EWXNJbXAwYVNJNklqUTBZVFV6TTJFeExUUXpNR1V0TkRabU1DMWhaRGswTFRrek9EQmxObVJqWTJFeE1DSXNJbk4xWWlJNkltUnJNelZ5YW1keGNHSjJZbkJ0Y1hJaUxDSnBjM01pT2lKb2RIUndjem92TDJGd2FTNXpZVzVrWW05NExtSnlZV2x1ZEhKbFpXZGhkR1YzWVhrdVkyOXRJaXdpYldWeVkyaGhiblFpT25zaWNIVmliR2xqWDJsa0lqb2laR3N6TlhKcVozRndZblppY0cxeGNpSXNJblpsY21sbWVWOWpZWEprWDJKNVgyUmxabUYxYkhRaU9uUnlkV1VzSW5abGNtbG1lVjkzWVd4c1pYUmZZbmxmWkdWbVlYVnNkQ0k2Wm1Gc2MyVjlMQ0p5YVdkb2RITWlPbHNpYldGdVlXZGxYM1poZFd4MElsMHNJbk5qYjNCbElqcGJJa0p5WVdsdWRISmxaVHBXWVhWc2RDSXNJa0p5WVdsdWRISmxaVHBEYkdsbGJuUlRSRXNpTENKQ2NtRnBiblJ5WldVNlFWaFBJbDBzSW05d2RHbHZibk1pT25zaWNHRjVjR0ZzWDJOc2FXVnVkRjlwWkNJNklrRmljbUk0ZUVsemQycFFSbEJ6TTA5bFRqbHliRGN5VTBka1ozVlNaWE5rU1VjNVpYbFhlVWxGVVRWRk5sTjNSWEZvWmpNdFpuVXpNbWhWTjBKNGRGSk9ibUV3WjFOclluWXhMWGxJTldWM0luMTkuLXpnZU9IN3EyWkd4dFR2d1Z5X0x0UlFfVklMeXZXekx6VjQybUhIVTRnc0NvRVFMblhXOFdxTV9qUEZyaU40X295TUZ4RW53UTQza3hNWE9URzRZT1EiLCJjb25maWdVcmwiOiJodHRwczovL2FwaS5zYW5kYm94LmJyYWludHJlZWdhdGV3YXkuY29tOjQ0My9tZXJjaGFudHMvZGszNXJqZ3FwYnZicG1xci9jbGllbnRfYXBpL3YxL2NvbmZpZ3VyYXRpb24iLCJncmFwaFFMIjp7InVybCI6Imh0dHBzOi8vcGF5bWVudHMuc2FuZGJveC5icmFpbnRyZWUtYXBpLmNvbS9ncmFwaHFsIiwiZGF0ZSI6IjIwMTgtMDUtMDgiLCJmZWF0dXJlcyI6WyJ0b2tlbml6ZV9jcmVkaXRfY2FyZHMiXX0sImNsaWVudEFwaVVybCI6Imh0dHBzOi8vYXBpLnNhbmRib3guYnJhaW50cmVlZ2F0ZXdheS5jb206NDQzL21lcmNoYW50cy9kazM1cmpncXBidmJwbXFyL2NsaWVudF9hcGkiLCJlbnZpcm9ubWVudCI6InNhbmRib3giLCJtZXJjaGFudElkIjoiZGszNXJqZ3FwYnZicG1xciIsImFzc2V0c1VybCI6Imh0dHBzOi8vYXNzZXRzLmJyYWludHJlZWdhdGV3YXkuY29tIiwiYXV0aFVybCI6Imh0dHBzOi8vYXV0aC52ZW5tby5zYW5kYm94LmJyYWludHJlZWdhdGV3YXkuY29tIiwidmVubW8iOiJvZmYiLCJjaGFsbGVuZ2VzIjpbImN2diIsInBvc3RhbF9jb2RlIl0sInRocmVlRFNlY3VyZUVuYWJsZWQiOnRydWUsImFuYWx5dGljcyI6eyJ1cmwiOiJodHRwczovL29yaWdpbi1hbmFseXRpY3Mtc2FuZC5zYW5kYm94LmJyYWludHJlZS1hcGkuY29tL2RrMzVyamdxcGJ2YnBtcXIifSwicGF5cGFsRW5hYmxlZCI6dHJ1ZSwiYnJhaW50cmVlX2FwaSI6eyJ1cmwiOiJodHRwczovL3BheW1lbnRzLnNhbmRib3guYnJhaW50cmVlLWFwaS5jb20iLCJhY2Nlc3NfdG9rZW4iOiJleUpyYVdRaU9pSXlNREU0TURReU5qRTJMWE5oYm1SaWIzZ2lMQ0pwYzNNaU9pSm9kSFJ3Y3pvdkwyRndhUzV6WVc1a1ltOTRMbUp5WVdsdWRISmxaV2RoZEdWM1lYa3VZMjl0SWl3aVlXeG5Jam9pUlZNeU5UWWlmUS5leUpsZUhBaU9qRTNOekUxTkRNNU5EWXNJbXAwYVNJNklqY3hOakZsWWpBekxUVmpOVGt0TkRObVpTMDVNamRqTFdZM1pqVXpOMkZrWldRNU55SXNJbk4xWWlJNkltUnJNelZ5YW1keGNHSjJZbkJ0Y1hJaUxDSnBjM01pT2lKb2RIUndjem92TDJGd2FTNXpZVzVrWW05NExtSnlZV2x1ZEhKbFpXZGhkR1YzWVhrdVkyOXRJaXdpYldWeVkyaGhiblFpT25zaWNIVmliR2xqWDJsa0lqb2laR3N6TlhKcVozRndZblppY0cxeGNpSXNJblpsY21sbWVWOWpZWEprWDJKNVgyUmxabUYxYkhRaU9uUnlkV1VzSW5abGNtbG1lVjkzWVd4c1pYUmZZbmxmWkdWbVlYVnNkQ0k2Wm1Gc2MyVjlMQ0p5YVdkb2RITWlPbHNpZEc5clpXNXBlbVVpTENKdFlXNWhaMlZmZG1GMWJIUWlYU3dpYzJOdmNHVWlPbHNpUW5KaGFXNTBjbVZsT2xaaGRXeDBJaXdpUW5KaGFXNTBjbVZsT2tOc2FXVnVkRk5FU3lJc0lrSnlZV2x1ZEhKbFpUcEJXRThpWFN3aWIzQjBhVzl1Y3lJNmUzMTkub2xDMmRYMUxQdkhVOHplUWJMbDFOTXVSWGlEUWx3VlJlZm8zaFlVdUhpMk9QdXZwamR2bWlicmdKUjJGWXNsRzR2NW1mSU9rTm5jdDEwcUFjM01IV3cifSwicGF5cGFsIjp7ImJpbGxpbmdBZ3JlZW1lbnRzRW5hYmxlZCI6dHJ1ZSwiZW52aXJvbm1lbnROb05ldHdvcmsiOmZhbHNlLCJ1bnZldHRlZE1lcmNoYW50IjpmYWxzZSwiYWxsb3dIdHRwIjp0cnVlLCJkaXNwbGF5TmFtZSI6IlBheVBhbCIsImNsaWVudElkIjoiQWJyYjh4SXN3alBGUHMzT2VOOXJsNzJTR2RndVJlc2RJRzlleVd5SUVRNUU2U3dFcWhmMy1mdTMyaFU3Qnh0Uk5uYTBnU2tidjEteUg1ZXciLCJiYXNlVXJsIjoiaHR0cHM6Ly9hc3NldHMuYnJhaW50cmVlZ2F0ZXdheS5jb20iLCJhc3NldHNVcmwiOiJodHRwczovL2NoZWNrb3V0LnBheXBhbC5jb20iLCJkaXJlY3RCYXNlVXJsIjpudWxsLCJlbnZpcm9ubWVudCI6Im9mZmxpbmUiLCJicmFpbnRyZWVDbGllbnRJZCI6Im1hc3RlcmNsaWVudDMiLCJtZXJjaGFudEFjY291bnRJZCI6Ik1lcmNoYW50X1VTQV8zIiwiY3VycmVuY3lJc29Db2RlIjoiVVNEIn19";
    // ===========================================

    // Use the current page as return/cancel (best for GitHub Pages)
    // App switch returns should land back on a page that runs hasReturned()/resume().
    const RETURN_URL = window.location.href;
    const CANCEL_URL = window.location.href;

    // If you later host a backend, set this to your API base URL (example):
    // const API_BASE = "https://your-backend.example.com";
    const API_BASE = ""; // keep empty for static demo

    let deviceData = "";

    function log(msg) {
      const el = document.getElementById('log');
      el.textContent = (new Date().toISOString() + "  " + msg + "\n") + el.textContent;
      console.log(msg);
    }

    function setOutput(obj) {
      document.getElementById("output").textContent = JSON.stringify(obj, null, 2);
    }

    function clearButtons() {
      document.getElementById('paypal-button-container').innerHTML = '';
    }

    async function renderPayPalButton() {
      const amount = document.getElementById('amount').value || '10.00';
      const intent = document.getElementById('intent').value || 'capture';
      const userAction = document.getElementById('userAction').value || 'commit';
      const enableAppSwitch = document.getElementById('enableAppSwitch').checked;
      const appSwitchNewTab = document.getElementById('appswitchNewTab').checked;

      clearButtons();
      setOutput("(nonce will appear here after approval)");

      if (!clientToken || clientToken === "REPLACE_WITH_FRESH_CLIENT_TOKEN") {
        log("ERROR: You must set a valid clientToken. (Hardcoded token expires; ideally fetch from server)");
        return;
      }

      try {
        log("Creating Braintree client...");
        const clientInstance = await braintree.client.create({ authorization: clientToken });

        log("Creating Data Collector...");
        try {
          const dc = await braintree.dataCollector.create({ client: clientInstance, paypal: true });
          deviceData = dc.deviceData || "";
          log("Device data collected (length=" + deviceData.length + ")");
        } catch (e) {
          // Not fatal for basic demo
          log("Data Collector failed (continuing): " + (e?.message || e));
        }

        log("Creating PayPal Checkout instance...");
        const paypalCheckoutInstance = await braintree.paypalCheckout.create({ client: clientInstance });

        // Load PayPal JS SDK
        const loadOptions = {
          currency: "USD",
          intent: intent,
          // env is optional; omit on GitHub Pages (PayPal decides based on token/environment)
          // env: "sandbox"
        };

        log("Loading PayPal SDK via Braintree...");
        await Promise.race([
          paypalCheckoutInstance.loadPayPalSDK(loadOptions),
          new Promise((_, reject) => setTimeout(() => reject(new Error("PayPal SDK loading timed out")), 10000))
        ]);

        if (!window.paypal?.Buttons) throw new Error("PayPal Buttons not available after SDK load");

        // Build the config (similar spirit to your GSE testbed)
        const buildButtonConfig = () => ({
          fundingSource: window.paypal.FUNDING.PAYPAL,

          appSwitchWhenAvailable: enableAppSwitch,
          preferences: {
            appSwitchWhenAvailable: enableAppSwitch,
            launchAppSwitchIn: appSwitchNewTab ? "newTab" : "sameTab",
          },

          createOrder: function () {
            log("createOrder called; creating PayPal payment via Braintree...");
            return paypalCheckoutInstance.createPayment({
              flow: "checkout",
              amount: String(amount),
              currency: "USD",
              intent: intent,
              userAction: userAction, // 'commit' or 'continue'
              noShipping: false,
              // App switch return/cancel
              returnUrl: RETURN_URL,
              cancelUrl: CANCEL_URL
            });
          },

          onApprove: function (data) {
            log("onApprove; tokenizing payment...");
            return paypalCheckoutInstance.tokenizePayment(data, function (err, payload) {
              if (err) {
                log("tokenizePayment error: " + (err?.message || err));
                return;
              }

              const result = {
                nonce: payload.nonce,
                details: payload.details,
                type: payload.type,
                payerId: payload.details?.payerId,
                email: payload.details?.email,
                deviceDataLength: deviceData ? deviceData.length : 0
              };

              log("Tokenized. Nonce received.");
              setOutput(result);

              // If you later have a backend, you'd do something like:
              // fetch(`${API_BASE}/checkout`, {...})
            });
          },

          onCancel: function (data) {
            log("Cancelled: " + JSON.stringify(data));
          },

          onError: function (err) {
            log("PayPal error: " + (err?.message || err));
            console.error(err);
          }
        });

        // --- Resume flow (like your GSE test bed) ---
        const tempButton = window.paypal.Buttons({ fundingSource: window.paypal.FUNDING.PAYPAL });
        const isReturning = tempButton.hasReturned();

        if (isReturning) {
          log("Detected return from PayPal (hasReturned=true). Resuming...");
          const resumeButton = window.paypal.Buttons(buildButtonConfig());
          await resumeButton.resume();
          return;
        }

        log("Rendering buttons...");
        const buttons = window.paypal.Buttons(buildButtonConfig());
        await buttons.render("#paypal-button-container");
        log("Buttons rendered.");
      } catch (e) {
        log("ERROR: " + (e?.message || e));
        console.error(e);
      }
    }

    document.getElementById('render').addEventListener('click', renderPayPalButton);

    window.addEventListener('load', () => {
      // Don’t auto-run if clientToken placeholder isn't set
      if (clientToken && clientToken !== "REPLACE_WITH_FRESH_CLIENT_TOKEN") {
        renderPayPalButton();
      } else {
        log("Set a valid clientToken first, then click Render PayPal Button.");
      }
    });
  </script>
</body>
</html>
